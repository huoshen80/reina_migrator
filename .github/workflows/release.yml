name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  
permissions:
  contents: write

jobs:
  build:
    name: Build Windows Release
    runs-on: windows-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: x86_64-pc-windows-msvc

    - name: Cache cargo dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          target/
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

    - name: Build release
      run: cargo build --release --target x86_64-pc-windows-msvc

    - name: Prepare artifact
      run: |
        mkdir release
        copy target\x86_64-pc-windows-msvc\release\reina_migrator.exe release\
        copy README.md release\

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: reina_migrator-x86_64-pc-windows-msvc
        path: release/

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: reina_migrator-x86_64-pc-windows-msvc
        path: ./artifacts
      
    - name: Create release archive
      run: |
        zip_name="reina_migrator-${{ github.ref_name }}.zip"
        cd artifacts && zip -r ../$zip_name . && cd ..

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: reina_migrator-${{ github.ref_name }}.zip
        body: |
          ## ReinaMigrator Release

          自动构建的 ReinaMigrator用于将 Whitecloud 数据库迁移到 ReinaManager。
          
          ### 使用方法
          1. 找到 `db.3.sqlite` 文件，它一般位于 `whitecloud安装路径\resources\data\db.3.sqlite`
          2. 将 `db.3.sqlite` 放在程序同一目录
          3. 运行 `reina_migrator.exe`
          4. 程序会自动将数据迁移到 `%APPDATA%\Roaming\com.reinamanager.dev\data\reina_manager.db`
        draft: false
        prerelease: false
